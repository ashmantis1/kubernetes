- name: Deploy infrastructure
  hosts: localhost
  connection: local
  
  tasks:
  - name: Create cloudinit directory
    ansible.builtin.file: 
      name: ../../terraform/cloudinit
      state: directory
  - name: Template cloudinit
    ansible.builtin.template:
      src: ../templates/cloudinit.yaml.jinja2
      dest: ../../terraform/cloudinit/user-data.yaml
    
  - name: Deploy vault nodes on proxmox
    community.general.terraform: 
      project_path: ../../terraform
      state: present
      complex_vars: true
      workspace: hl-vault-workspace
      variables:
        dns_zone: "{{dns_zone}}"
        dns_key_name: "{{dns_key_name}}"
        dns_key_secret: "{{dns_key_secret}}"
        dns_server: "{{dns_server}}"
        proxmox_host: "{{proxmox_host}}"
        proxmox_user: "{{proxmox_user}}"
        proxmox_password: "{{proxmox_password}}"
        nodes: "{{master_nodes}}"
        master_count: "{{master_count}}"
        master_cpu: "{{master_cpu}}"
        master_memory: "{{master_memory}}"
        disk_size: "{{disk_size}}"
    register: tf_out 
  - name: Add masters to inventory 
    ansible.builtin.add_host:
      name: "{{item}}"
      groups: masters
    loop: "{{tf_out.outputs.master_ips.value}}"

  