- name: Configure workers
  hosts: workers:masters
  strategy: free
  become: yes
  tasks:
    - name: run configuration
      include_role:
        name: ../roles/node_setup
      vars:
        kubernetes_version: "{{kubeversion}}"
    - name: Set hostname to var
      ansible.builtin.command: hostname -I
      register: node_ip
      
    - name: get index of ip relative to masters array and add one to set it to master value
      ansible.builtin.set_fact:
        index: "{{ (lookup('ansible.utils.index_of', data=groups['workers'], test='search', value=node_ip.stdout|trim) | int) +1 }}"
      when: inventory_hostname in groups['workers']
    - name: Set hostname
      ansible.builtin.shell: sudo hostnamectl set-hostname 'worker{{ "%02d" | format(index|int) }}.{{cluster_name}}.{{dns_zone}}'
      when: inventory_hostname in groups['workers']

    - name: get index of ip relative to masters array and add one to set it to master value
      ansible.builtin.set_fact:
        index: "{{ (lookup('ansible.utils.index_of', data=groups['masters'], test='search', value=node_ip.stdout|trim) | int) +1 }}"
      when: inventory_hostname in groups['masters']
    - name: Set hostname
      ansible.builtin.shell: sudo hostnamectl set-hostname 'master{{ "%02d" | format(index|int) }}.{{cluster_name}}.{{dns_zone}}'
      when: inventory_hostname in groups['masters']