- name: Setup kubernetes cluster
  hosts: bootstrap 
  become: true 
  tasks: 
    - name: Approve all CSRs
      ansible.builtin.shell: kubectl --kubeconfig=/etc/kubernetes/admin.conf get csr -ojson | jq -r '.items[] | select(.status == {} ) | .metadata.name' | xargs kubectl --kubeconfig=/etc/kubernetes/admin.conf certificate approve
      #kubectl get csr | grep Pending | awk '{print $1}' | xargs kubectl certificate approve
    - name: Install python k8s 
      ansible.builtin.apt:
        name: python3-kubernetes
        state: present
    
    - name: deploy cilium
      include_role:
        name: ../roles/cilium
    - name: add worker label to nodes
  
      k8s: 
        kubeconfig: "/etc/kubernetes/admin.conf"
        state: present
        definition:
          apiVersion: v1
          kind: Node
          metadata: 
            name: "k8s-worker-{{'%02d' | format(ansible_loop.index)}}"
            labels: 
              node-role.kubernetes.io/worker: worker
      loop: "{{groups['workers']}}"
      loop_control: 
        extended: true
    - name: Copy kubernetes kubeconfig to localhost 
      ansible.builtin.fetch:
        src: /etc/kubernetes/admin.conf
        dest: ~/.kube/admin.conf
        flat: yes 
    - name: inform user to wait for cilium to be deployed
      ansible.builtin.debug:
        msg: "The cluster should now be up and running. The kubeconfig file has been copied into ~/.kube/admin.conf. Please wait for cilium to be deployed before the nodes are ready."