- name: Boostrap node for k8s cluster 
  hosts: bootstrap
  become: true
  tasks:
    - name: Rune kube-vip configuration
      include_role:
        name: ../roles/kube_vip
      vars:
        interface: "{{api_loadbalancer_interface}}"
        vip: "{{api_loadbalancer_ip}}"
    - name: Template bgp config map to /etc/kubernetes/manifests folder
      ansible.builtin.template:
        src: ../templates/cilium-bgp-cm.yaml.jinja2
        dest: /etc/kubernetes/manifests/cilium-bgp-cm.yaml
    - name: Initialise cluster using kubeadm
      ansible.builtin.shell: kubeadm init --control-plane-endpoint "{{api_loadbalancer_ip}}:6443" --upload-certs --kubernetes-version "{{kubeversion}}" --skip-phases=addon/kube-proxy
      register: kubeadm_init
    - name: Extract certificate key
      set_fact:
        certificate_key: "{{ kubeadm_init.stdout | regex_search('--certificate-key (\\S+)') | regex_replace('--certificate-key ', '') }}"
      # The regular expression '--certificate-key (\\S+)' captures the non-whitespace characters after '--certificate-key'.
    - name: create new join command
      ansible.builtin.shell: kubeadm token create --print-join-command
      register: kubeadm_join_command
    - name: create control plane join command
      set_fact:
        control_plane_join_command: "{{ kubeadm_join_command.stdout }} --control-plane --certificate-key {{ certificate_key }}"
    - name: create worker join command
      set_fact:
        worker_join_command: "{{ kubeadm_join_command.stdout }}"
    - name: print join command
      debug:
        var: control_plane_join_command

    - name: Sleep for 60 seconds
      ansible.builtin.wait_for:
        timeout: 60
 
