- name: Boostrap node for k8s cluster 
  hosts: bootstrap
  become: true
  tasks:
    #- name: Rune kube-vip configuration
      # include_role:
      #   name: ../roles/kube_vip
      # vars:
      #   interface: "{{api_loadbalancer_interface}}"
      #   vip: "{{api_loadbalancer_ip}}"
    - name: Template kube-vip to /etc/kubernetes/manifests folder
      ansible.builtin.template:
        src: ../templates/kube-vip.yaml.jinja2
        dest: /etc/kubernetes/manifests/kube-vip.yaml
    # Configure kubeadm and kubelet values in the ansible/templates/kubeadm-config.yaml.jinja2 file. Other types of configurations can be added here. 
    - name: kubeadm and kubelet config file to /tmp folder
      ansible.builtin.template:
        src: ../templates/kubeadm-config.yaml.jinja2
        dest: /tmp/kubeadm-config.yaml
    - name: Template bgp config map to /etc/kubernetes/manifests folder
      ansible.builtin.template:
        src: ../templates/cilium-bgp-cm.yaml.jinja2
        dest: /etc/kubernetes/manifests/cilium-bgp-cm.yaml
    - name: Initialise cluster using kubeadm
      # additional  flags: --control-plane-endpoint "{{api_loadbalancer_ip}}:6443" --kubernetes-version "{{kubeversion}}"
      ansible.builtin.shell: kubeadm init  --upload-certs --skip-phases=addon/kube-proxy --config=/tmp/kubeadm-config.yaml
      register: kubeadm_init

    - name: Sleep for 30 seconds
      ansible.builtin.wait_for:
        timeout: 30
 
    - name: Extract certificate key
      set_fact:
        certificate_key: "{{ kubeadm_init.stdout | regex_search('--certificate-key (\\S+)') | regex_replace('--certificate-key ', '') }}"
      # The regular expression '--certificate-key (\\S+)' captures the non-whitespace characters after '--certificate-key'.
    - name: create new join command
      ansible.builtin.shell: kubeadm token create --print-join-command
      register: kubeadm_join_command
    - name: create control plane join command
      set_fact:
        control_plane_join_command: "{{ kubeadm_join_command.stdout }} --control-plane --certificate-key {{ certificate_key }}"
    - name: create worker join command
      set_fact:
        worker_join_command: "{{ kubeadm_join_command.stdout }}"
    - name: print join command
      debug:
        var: control_plane_join_command

    - name: Sleep for 120 seconds
      ansible.builtin.wait_for:
        timeout: 120
 
