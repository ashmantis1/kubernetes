
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: oidc-clients
spec:
  refreshInterval: 15s
  secretStoreRef:
    kind: ClusterSecretStore
    name: vault-backend
  target:
    name: oidc-clients
    template:
      engineVersion: v2
      data:
        configuration.oidc.yaml: |
          identity_providers:
            oidc:
              jwks:
                - key: |
          {{ .config_jwks_key | indent 10 }}
              hmac_secret: '{{ .config_hmac_secret }}'
              ## The other portions of the mandatory OpenID Connect 1.0 configuration go here.
              ## See: https://www.authelia.com/c/oidc
              clients:
                - client_id: 'Minio'
                  client_name: 'MinIO'
                  client_secret: '{{ .minio_password | bcrypt }}'  # The digest of 'insecure_secret'.
                  public: false
                  authorization_policy: 'one_factor'
                  consent_mode: pre-configured
                  pre_configured_consent_duration: 6M
                  redirect_uris:
                    - 'https://minio01.infra.ashman.world:9092/oauth_callback'
                  scopes:
                    - 'openid'
                    - 'profile'
                    - 'email'
                    - 'groups'
                  userinfo_signed_response_alg: 'none'

  data:
  - secretKey: minio_password
    remoteRef:
      key: k8s/oauth/authelia/clients/minio
      property: password
  - secretKey: config_jwks_key
    remoteRef:
      key: k8s/oauth/authelia/config
      property: jwks_key
  - secretKey: config_hmac_secret
    remoteRef:
      key: k8s/oauth/authelia/config
      property: hmac_secret
