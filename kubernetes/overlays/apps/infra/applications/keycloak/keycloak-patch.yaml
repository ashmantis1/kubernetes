# yaml-language-server: $schema=https://kubernetes-schemas.devbu.io/helm.toolkit.fluxcd.io/helmrelease_v2beta1.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: keycloak
spec:
  chart:
    spec:
      chart: keycloak
      version: "24.6.3"
      sourceRef:
        kind: HelmRepository
        name: bitnami
        namespace: flux-system
  values: 
    production: true
    replicaCount: 3
    proxy: passthrough
    networkPolicy:
      allowExternal: false
      extraIngress:
      - ports:
        - port: 8443
        from:
        - namespaceSelector:
            matchLabels:
              role: ingress-controller
    tls: 
      enabled: true
      autoGenerated: true
    postgresql:
      enabled: false
    externalDatabase: 
      existingSecret: keycloak-postgres-app
      existingSecretHostKey: host
      existingSecretPortKey: port
      existingSecretUserKey: user
      existingSecretDatabaseKey: dbname
      existingSecretPasswordKey: password
    ingress:
      enabled: true
      ingressClassName: nginx
      servicePort: https
      hostname: auth.apps.ashman.world
      annotations:
        cert-manager.io/cluster-issuer: "letsencrypt-issuer"
        nginx.ingress.kubernetes.io/backend-protocol: "HTTPS"
        nginx.ingress.kubernetes.io/proxy-ssl-verify: "off"
        nginx.ingress.kubernetes.io/whitelist-source-range: "0.0.0.0/0"
        nginx.ingress.kubernetes.io/ssl-passthrough: "true"
      tls: true
    resources:
      requests:
        memory: 2048Mi
      limits:
        memory: 4096Mi
    adminIngress:
      enabled: true
      ingressClassName: nginx
      servicePort: https
      hostname: auth-admin.apps.ashman.world
      annotations:
        cert-manager.io/cluster-issuer: "letsencrypt-issuer"
        nginx.ingress.kubernetes.io/ssl-passthrough: "true"
        nginx.ingress.kubernetes.io/backend-protocol: "HTTPS"
        nginx.ingress.kubernetes.io/proxy-ssl-verify: "off"
      tls: true
    auth: 
      adminUser: admin
      existingSecret: keycloak-tmp-admin
      passwordSecretKey: password
    keycloakConfigCli:
      enabled: false
      existingConfigmap: keycloak-config
    extraVolumes:
      - name: ipa-ca
        configMap:
          name: ipa-ca-truststore
    extraVolumeMounts:
      - name: ipa-ca
        mountPath: "/etc/ssl/certs/ca.truststore"
        subPath: ca.truststore
        readOnly: true
    extraEnvVars:
      - name: JAVA_OPTS
        value: "-Djavax.net.ssl.trustStore=/etc/ssl/certs/ca.truststore -Djavax.net.ssl.trustStorePassword=changeit"



