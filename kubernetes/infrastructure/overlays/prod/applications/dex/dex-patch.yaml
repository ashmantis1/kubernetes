# yaml-language-server: $schema=https://kubernetes-schemas.devbu.io/helm.toolkit.fluxcd.io/helmrelease_v2beta1.json
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: dex
  namespace: dex
spec:
  chart:
    spec:
      chart: dex
      version: "0.15.3"
  values: 
    # https:
    #   enabled: true
    ingress: 
      enabled: true 
      className: nginx
      annotations:
        cert-manager.io/cluster-issuer: letsencrypt-prod
      hosts: 
        - host: dex.k8s.ashman.world
          paths: 
            - path: / 
              pathType: Prefix
      tls: 
        - secretName: dex-ingress-tls
          hosts: 
            - dex.k8s.ashman.world
    envFrom: 
      - secretRef: 
          name: dex-secret
    config: 
      issuer: "https://dex.k8s.ashman.world"
      staticClients: 
        - id: kubelogin
          redirectURIs: 
            - http://localhost:8000
            - http://localhost:18000
            - http://127.0.0.1:5555/callback
            - https://console.k8s.ashman.world/auth/callback
            - https://flux.k8s.ashman.world
          name: OIDC Connector
          secretEnv: KUBELOGIN_CLIENT_SECRET 
      connectors: 
        - type: github
          id: github
          name: GitHub
          config: 
            clientId: $GITHUB_CLIENT_ID
            clientSecret: $GITHUB_CLIENT_SECRET
            redirectURI: "https://dex.k8s.ashman.world/callback"
      